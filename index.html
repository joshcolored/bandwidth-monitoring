<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>

  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --border: #374151;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
    }

    * {
      box-sizing: border-box;
    }

    #update-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .update-box {
      background: #111827;
      border: 1px solid #374151;
      padding: 20px;
      border-radius: 12px;
      width: 360px;
      text-align: center;
    }

    .progress-bar {
      height: 8px;
      background: #374151;
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    #progress-fill {
      height: 100%;
      width: 0%;
      background: #3b82f6;
      transition: width .2s;
    }

    #restart-btn {
      background: #3b82f6;
      border: none;
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    body {
      margin: 0;
      height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family:
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      display: flex;
      flex-direction: column;
    }

    /* ===== TABS ===== */
    .tabs {
      display: flex;
      background: linear-gradient(to right, #0b1220, #111827);
      border-bottom: 1px solid var(--border);
    }

    .tabs button {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
    }

    .tabs button.active {
      color: #fff;
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
    }

    /* ===== TAB ICON ===== */
    .tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn img {
      width: 18px;
      height: 18px;
      object-fit: contain;
      filter: grayscale(100%);
      opacity: 0.8;
    }

    .tabs button.active img {
      filter: none;
      opacity: 1;
    }

    /* ===== VIEWS ===== */
    .view {
      display: none;
      flex: 1;
    }

    .view.active {
      display: flex;
    }

    .single {
      padding: 0;
    }

    .combined.active {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
    }

    /* ===== CLEAN SINGLE VIEW ===== */
    .clean {
      position: relative;
      flex: 1;
    }

    /* ===== ZOOM FLOATING CONTROLS ===== */
    .zoom-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      gap: 4px;
    }

    .zoom-controls button {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--border);
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .zoom-controls button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ===== COMBINED CARDS ===== */
    .card {
      background: var(--card);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.25);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-left img {
      width: 16px;
      height: 16px;
      object-fit: contain;
    }

    .body {
      flex: 1;
      position: relative;
    }

    webview {
      width: 100%;
      height: 100%;
    }

    /* ===== AUTO-HIDE SCROLLBAR ===== */
    body.hide-scrollbar {
      scrollbar-width: none;
      /* Firefox */
    }

    body.hide-scrollbar::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .last-updated {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 12;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid var(--border);
      color: #e5e7eb;
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 4px;
      pointer-events: none;
      white-space: nowrap;
    }

    /* Optional: when visible */
    body::-webkit-scrollbar {
      width: 8px;
    }

    body::-webkit-scrollbar-track {
      background: transparent;
    }

    body::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.25);
      border-radius: 6px;
    }

    .zoom-controls .pldt-range-switch button.active {
      background: var(--accent);
    }

    .refresh-status {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 15;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      color: #9ca3af;
      pointer-events: none;
    }

    .refresh-status.active {
      color: #22c55e;
    }

    .refresh-status.paused {
      color: #f59e0b;
    }
  </style>
</head>

<body>
  <!-- ===== TABS ===== -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab(0)">
      <img src="assets/pldt.png" alt="PLDT" />
      <span>PLDT</span>
    </button>

    <button class="tab-btn" onclick="showTab(1)">
      <img src="assets/globe.png" alt="Globe" />
      <span>GLOBE</span>
    </button>

    <button class="tab-btn" onclick="showTab(2)">
      <img src="assets/eastern.png" alt="Eastern Telcom" />
      <span>EASTERN TELECOM</span>
    </button>

    <button class="tab-btn" onclick="showTab(3)">
      <span>ALL BANDWIDTH</span>
    </button>
  </div>

  <!-- ===== TAB 1 ===== -->
  <div class="view active single">
    <div class="clean">
      <div class="last-updated" id="updated-1"></div>
      <div class="refresh-status">
        ‚è∏ Refresh Paused
      </div>
      <div class="zoom-controls">
        <div class="pldt-range-switch">
          <button onclick="setPLDTRange('6h', this)">6H</button>
          <button onclick="setPLDTRange('1d', this)">1D</button>
          <button onclick="setPLDTRange('7d', this)" class="active">7D</button>
          <button onclick="setPLDTRange('14d', this)">14D</button>
          <button onclick="setPLDTRange('30d', this)">30D</button>
        </div>

        <button onclick="zoomIn(0)">+</button>
        <button onclick="zoomOut(0)">‚àí</button>
        <button onclick="resetZoom(0)">‚ü≥</button>
      </div>
      <div id="slot-1" style="height: 100%"></div>
    </div>
  </div>

  <!-- ===== TAB 2 ===== -->
  <div class="view single">
    <div class="clean">
      <div class="last-updated" id="updated-2"></div>
      <div class="refresh-status">
        ‚è∏ Refresh Paused
      </div>
      <div class="zoom-controls">
        <button onclick="zoomIn(1)">+</button>
        <button onclick="zoomOut(1)">‚àí</button>
        <button onclick="resetZoom(1)">‚ü≥</button>
      </div>
      <div id="slot-2" style="height: 100%"></div>
    </div>
  </div>

  <!-- ===== TAB 3 ===== -->
  <div class="view single">
    <div class="clean">
      <div class="last-updated" id="updated-3"></div>
      <div class="refresh-status">
        ‚è∏ Refresh Paused
      </div>

      <div class="zoom-controls">
        <button onclick="zoomIn(2)">+</button>
        <button onclick="zoomOut(2)">‚àí</button>
        <button onclick="resetZoom(2)">‚ü≥</button>
      </div>
      <div id="slot-3" style="height: 100%"></div>
    </div>
  </div>

  <!-- ===== COMBINED TAB ===== -->
  <div class="view combined">
    <div class="card">
      <div class="header">
        <div class="header-left">
          <img src="assets/pldt.png" />
          <span>PLDT</span>
        </div>
        <div>
          <button onclick="setPLDTRange('6h', this)">6H</button>
          <button onclick="setPLDTRange('1d', this)">1D</button>
          <button onclick="setPLDTRange('7d', this)" class="active">7D</button>
          <button onclick="setPLDTRange('14d', this)">14D</button>
          <button onclick="setPLDTRange('30d', this)">30D</button>

          <button onclick="zoomIn(0)">+</button>
          <button onclick="zoomOut(0)">‚àí</button>
          <button onclick="resetZoom(0)">‚ü≥</button>
        </div>
      </div>
      <div class="body" id="slot-c1">
        <div class="last-updated" id="updated-c1"></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <div class="header-left">
          <img src="assets/globe.png" />
          <span>GLOBE</span>
        </div>
        <div>
          <button onclick="zoomIn(1)">+</button>
          <button onclick="zoomOut(1)">‚àí</button>
          <button onclick="resetZoom(1)">‚ü≥</button>
        </div>
      </div>
      <div class="body" id="slot-c2">
        <div class="last-updated" id="updated-c2"></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <div class="header-left">
          <img src="assets/eastern.png" />
          <span>EASTERN TELECOM</span>
        </div>
        <div>
          <button onclick="zoomIn(2)">+</button>
          <button onclick="zoomOut(2)">‚àí</button>
          <button onclick="resetZoom(2)">‚ü≥</button>
        </div>
      </div>
      <div class="body" id="slot-c3">
        <div class="last-updated" id="updated-c3"></div>
      </div>
    </div>
  </div>

  <script>
    /* ======================
       GLOBAL FLAGS
    ====================== */
    let autoRefreshGlobe = true;
    let autoRefreshEastern = true;
    let pldtDomReady = false;
    let refreshEnabled = true;

    /* ======================
       CONFIG
    ====================== */
    const PLDT_INDEX = 0;
    const REFRESH_INTERVAL = 3 * 60 * 1000; // 3 minutes
    const PLDT_RELOAD_INTERVAL = 5 * 60 * 1000; // 5 minutes SAFE
    const EASTERN_INDEX = 2;
    const EASTERN_UTIL_CLICK_INTERVAL = 3 * 60 * 1000; // 3 minutes


    /* ======================
       WEBVIEWS
    ====================== */
    const webviews = [
      makeWV("https://i-gate.net.ph/client/public/"),
      makeWV("https://mrtg.globebusiness.com.ph/mrtg_customer/index.php?module=my_connection"),
      makeWV("https://bandwidth10.eastern-tele.com/cacti/graph_view.php")
    ];

    webviews[PLDT_INDEX].addEventListener('dom-ready', () => {
      pldtDomReady = true;
      console.log('[PLDT] webview dom-ready');
    });

    function makeWV(src) {
      const w = document.createElement("webview");
      w.src = src;
      w.style.width = "100%";
      w.style.height = "100%";
      return w;
    }

    document.getElementById("slot-1").appendChild(webviews[0]);

    function updateRefreshStatus() {
      const activeView = document.querySelector('.view.active');
      if (!activeView) return;

      const el = activeView.querySelector('.refresh-status');
      if (!el) return;

      refreshEnabled = autoRefreshGlobe || autoRefreshEastern;

      if (refreshEnabled) {
        el.textContent = '‚ñ∂ Refresh Active';
        el.classList.add('active');
        el.classList.remove('paused');
      } else {
        el.textContent = '‚è∏ Refresh Paused';
        el.classList.add('paused');
        el.classList.remove('active');
      }
    }

    /* ====================== 
       EASTERN UTILS
    ====================== */
    function safeEasternExec(script) {
      const wv = webviews[EASTERN_INDEX];
      if (!wv) return;

      wv.executeJavaScript(`
    (function(){
      try {
        ${script}
      } catch(e) {
        console.warn('[Eastern inject skipped]', e);
      }
    })();
  `, true).catch(() => { });
    }

    /* ====================== 
       EASTERN UTILS
    ====================== */
    function clickEasternUtilities() {
      safeEasternExec(`
    const btn = document.getElementById('graph_41775_util');
    if (btn) {
      btn.click();
      console.log('[Eastern] Utilities button clicked');
    } else {
      console.warn('[Eastern] Utilities button not found');
    }
  `);
    }

    let easternUtilTimer = null;

    function startEasternUtilLoop() {
      if (easternUtilTimer) return;

      easternUtilTimer = setInterval(() => {
        if (
          autoRefreshEastern &&
          (activeTab === 2 || activeTab === 3)
        ) {
          clickEasternUtilities();
        }
      }, EASTERN_UTIL_CLICK_INTERVAL);
    }

    function stopEasternUtilLoop() {
      if (easternUtilTimer) {
        clearInterval(easternUtilTimer);
        easternUtilTimer = null;
      }
    }


    /* ======================
       PLDT RANGE STATE
    ====================== */
    let pldtRange = '7d';

    /* ======================
       RANGE HANDLER
    ====================== */
    function setPLDTRange(range, el) {
      pldtRange = range;

      document
        .querySelectorAll('.pldt-range-switch button')
        .forEach(b => b.classList.remove('active'));

      if (el) el.classList.add('active');

      injectPLDTIntoIframe();
      resetRefreshTimer();
    }


    function isRefreshAllowedForTab() {
      if (activeTab === 1 && !autoRefreshGlobe) return false;
      if (activeTab === 2 && !autoRefreshEastern) return false;

      if (activeTab === 3) {
        // ALL BANDWIDTH ‚Üí refresh ONLY if at least one is enabled
        return autoRefreshGlobe || autoRefreshEastern;
      }

      return true;
    }

    /* ======================
       TAB MANAGEMENT
    ====================== */
    let activeTab = 0;

    function showTab(i) {
      activeTab = i;

      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));

      document.querySelectorAll(".view")[i].classList.add("active");
      document.querySelectorAll(".tabs button")[i].classList.add("active");

      if (i === 0) slot("slot-1", 0);
      if (i === 1) slot("slot-2", 1);
      if (i === 2) slot("slot-3", 2);

      if (i === 3) {
        slot("slot-c1", 0);
        slot("slot-c2", 1);
        slot("slot-c3", 2);
      }

      if (i === 2 || i === 3) {
        startEasternUtilLoop();
      } else {
        stopEasternUtilLoop();
      }


      if (i === 0 || i === 3) {
        const waitForPLDT = setInterval(() => {
          if (pldtDomReady) {
            injectPLDTIntoIframe();
            startPLDTLoop();
            clearInterval(waitForPLDT);
          }
        }, 100);
      } else {
        stopPLDTLoop();
      }

      updateRefreshStatus();
      resetRefreshTimer();
    }

    function slot(id, index) {
      const el = document.getElementById(id);
      const wv = webviews[index];

      if (!el.contains(wv)) {
        // üî• IMPORTANT: reset dom-ready when moving webview
        if (index === PLDT_INDEX) {
          pldtDomReady = false;
          console.log('[PLDT] webview moved ‚Üí waiting for dom-ready');
        }

        el.appendChild(wv);
      }
    }

    webviews[EASTERN_INDEX].addEventListener('did-finish-load', () => {
      if (autoRefreshEastern) {
        setTimeout(clickEasternUtilities, 2000);
      }
    });



    /* ======================
       PLDT URL BUILDER (FIXED)
    ====================== */
    function buildPLDTURL() {
      const now = new Date();
      const start = new Date(now);

      switch (pldtRange) {
        case '6h': start.setHours(start.getHours() - 6); break;
        case '1d': start.setDate(start.getDate() - 1); break;
        case '7d': start.setDate(start.getDate() - 7); break;
        case '14d': start.setDate(start.getDate() - 14); break;
        case '30d': start.setDate(start.getDate() - 30); break;
      }

      return (
        "https://i-gate.net.ph/client/public/dashboard/dashboardChart" +
        "?id=22445" +
        "&startdate=" + encodeURIComponent(start.toISOString().slice(0, 19).replace("T", " ")) +
        "&enddate=" + encodeURIComponent(now.toISOString().slice(0, 19).replace("T", " ")) +
        "&conversion_type=bps"
      );
    }

    /* ======================
       SAFE EXEC
    ====================== */
    function safePLDTExec(script) {
      const wv = webviews[PLDT_INDEX];
      if (!wv || !pldtDomReady) {
        console.warn('[PLDT] exec skipped (webview not ready)');
        return;
      }

      wv.executeJavaScript(`
    (function(){
      try {
        ${script}
      } catch (e) {
        console.warn('[PLDT inject error]', e);
      }
    })();
  `, true).catch(() => {
        // swallow race-condition errors
      });
    }


    /* ======================
       INJECT PLDT
    ====================== */
    function injectPLDTIntoIframe() {
      if (!pldtDomReady) return;

      const url = buildPLDTURL();

      safePLDTExec(`
    const iframe = document.getElementById('youriframe');
    if (!iframe) return;

    if (iframe.src !== "${url}") {
      iframe.src = "${url}";
    }
  `);
      updateTimestamp(activeTab === 0 ? 'updated-1' : 'updated-c1');
    }

    /* ======================
       IDLE NEUTRALIZER
    ====================== */
    function neutralizePLDTIdle() {
      safePLDTExec(`
    if (window.CheckIdleTime) window.CheckIdleTime = function(){};
    if (window.IDLE_TIMEOUT) window.IDLE_TIMEOUT = 99999999;

    const modal = document.getElementById('modal_session');
    if (modal) modal.remove();
  `);
    }

    webviews[PLDT_INDEX].addEventListener('did-finish-load', () => {
      neutralizePLDTIdle();
    });

    /* ======================
       PLDT SAFE LOOP
    ====================== */
    let pldtTimer = null;

    function startPLDTLoop() {
      if (pldtTimer) return;

      pldtTimer = setInterval(() => {
        if (activeTab === 0 || activeTab === 3) {
          injectPLDTIntoIframe();
          neutralizePLDTIdle();
        }
      }, PLDT_RELOAD_INTERVAL);
    }

    function stopPLDTLoop() {
      if (pldtTimer) {
        clearInterval(pldtTimer);
        pldtTimer = null;
      }
    }

    /* ======================
       NORMAL REFRESH
    ====================== */
    let refreshTimer = null;

    function resetRefreshTimer() {
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshTimer = setTimeout(refreshVisibleGraphs, REFRESH_INTERVAL);
    }

    function refreshVisibleGraphs() {
      if (!isRefreshAllowedForTab()) {
        resetRefreshTimer();
        return;
      }

      // GLOBE
      if (
        (activeTab === 1 || activeTab === 3) &&
        autoRefreshGlobe
      ) {
        webviews[1].reload();
        updateTimestamp(activeTab === 1 ? 'updated-2' : 'updated-c2');
      }

      // EASTERN
      if (
        (activeTab === 2 || activeTab === 3) &&
        autoRefreshEastern
      ) {
        webviews[2].reload();
        updateTimestamp(activeTab === 2 ? 'updated-3' : 'updated-c3');
      }

      // üîÅ KEEP PLDT RANGE
      if (activeTab === 0 || activeTab === 3) {
        injectPLDTIntoIframe();
      }

      updateRefreshStatus();
      resetRefreshTimer();
    }

    /* ======================
       TIMESTAMP
    ====================== */
    function updateTimestamp(id) {
      const el = document.getElementById(id);
      if (!el) return;

      const now = new Date();
      el.textContent = 'üïí Updated: ' + now.toLocaleString();
    }



    /* ======================
   ZOOM CONTROLS (RESTORED)
====================== */
    const zoom = [1, 1, 1];

    function zoomIn(index) {
      if (!webviews[index]) return;
      zoom[index] += 0.1;
      webviews[index].setZoomFactor(zoom[index]);
    }

    function zoomOut(index) {
      if (!webviews[index]) return;
      zoom[index] = Math.max(0.2, zoom[index] - 0.1);
      webviews[index].setZoomFactor(zoom[index]);
    }

    function resetZoom(index) {
      if (!webviews[index]) return;
      zoom[index] = 1;
      webviews[index].setZoomFactor(1);
    }

    window.electronAPI.onToggleGlobe(val => {
      autoRefreshGlobe = val;
      updateRefreshStatus();
    });

    window.electronAPI.onToggleEastern(val => {
      autoRefreshEastern = val;
      updateRefreshStatus();
    });

    function resetRefreshTimer() {
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshTimer = setTimeout(refreshVisibleGraphs, REFRESH_INTERVAL);
    }
    /* ======================
       START
    ====================== */
    resetRefreshTimer();
  </script>



  <div id="update-modal" style="display:none">
    <div class="update-box">
      <h3>Updating Application</h3>
      <p id="update-text">Checking for updates‚Ä¶</p>
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <button id="restart-btn" style="display:none">Restart Now</button>
    </div>
  </div>

</body>

</html>